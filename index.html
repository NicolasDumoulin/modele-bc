 
<html>
    <head>
        <title>Various Bounded Confidence</title>
        <link href="css/bootstrap-3.3.6.min.css" rel="stylesheet">
        <script type="text/javascript"  src="js/plotly-latest.min.js"></script>
        <script type="text/javascript" src="js/population.js"></script>
        <script type="text/javascript" src="js/plots.js"></script>
        <script type="text/javascript" src="js/jquery-2.2.0.min.js"></script>
        <script type="text/javascript" src="js/bootstrap-3.3.6.min.js"></script>
    </head>
    <body>
        <div class="modal fade" id="confirm-stop" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog"><div class="modal-content">
                    <div class="modal-header"><h4 class="modal-title" id="myModalLabel">Confirmation</h4></div>
                    <div class="modal-body">Are you sure to stop this simulation and to reset all the results?</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button id="stop-confirmed" type="button" class="btn btn-danger danger">Stop</button>
                    </div>
                </div>
            </div>
        </div>                
        <div class="container">
            <div class="jumbotron">
                <h1>Various Bounded Confidence</h1>
                <p class="lead">Discover the dynamics of bounded confidence models<!-- described in
                    <a href="http://jasss.soc.surrey.ac.uk/19/1/6.html" title="Mathias, Jean-Denis, Huet, Sylvie and Deffuant, Guillaume (2016) 'Bounded Confidence Model with Fixed Uncertainties and Extremists: The Opinions Can Keep Fluctuating Indefinitely' Journal of Artificial Societies and Social Simulation 19 (1) 6">(Deffuant et al., 2016)</a-->
                </p>
            </div>
            <!--div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Help</h3>
                </div>
                <div class="panel-body">
                    
                </div>
            </div-->
            <div id="simulator">
                <div class="input-group col-sm-12">
                    <label id="play-btn" class="btn btn-default input-group-addon"><span class="glyphicon glyphicon-play"></span></label>
                    <span class="input-group-addon" id="iterationSlider-val">0</span>
                    <input id="iterationSlider" class="form-control" type="range" min="0" value="0"/>
                    <span class="input-group-addon" id="iterationSlider-max"></span>
                    <label id="stop-btn" class="btn btn-default input-group-addon" data-toggle="modal" data-target="#confirm-stop"><span class="glyphicon glyphicon-stop"></span></label>
                </div>
                <form  id="plots-frequency">
                    <div class="input-group col-sm-6">
                        <span class="input-group-addon" title="Sets the frequency of the computing and redrawing process for the plots.">
                            Plots frequency
                        </span>
                        <div class="btn-group" data-toggle="buttons">
                            <label class="btn btn-default active" title="Computes a frequency giving low-priority for plots">
                                <input type="radio" name="options" value="auto" autocomplete="off" checked>Auto
                            </label>
                            <label class="btn btn-default" title="Every timestep">
                                <input type="radio" name="options" value="1" autocomplete="off">1
                            </label>
                            <label class="btn btn-default" title="Every 10 timesteps">
                                <input type="radio" name="options" value="10" autocomplete="off">10
                            </label>
                            <label class="btn btn-default" title="Every 100 timesteps">
                                <input type="radio" name="options" value="100" autocomplete="off">100
                            </label>
                            <label class="btn btn-default" title="Disable the plots updating process">
                                <input type="radio" name="options" value="off" autocomplete="off">Off
                            </label>
                        </div>
                    </div>
                </form>
                <!-- Nav tabs -->
                <ul id="tabs" class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#config" aria-controls="config" role="tab" data-toggle="tab">Config</a></li>                        
                    <li role="presentation"><a href="#plots" aria-controls="plots" role="tab" data-toggle="tab">Plots</a></li>
                    <a id="permalink" href="" class="btn glyphicon glyphicon-link"
                       type="button" title="Permalink to current parameters, for sharing or bookmarking your experiment."></a>
                    <button id="resetParameters" href="" class="btn glyphicon glyphicon-trash"
                            type="button" title="Reset to default parameters."></button>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="config">
                        <form class="form-horizontal" role="form">
                            <div class="form-group">
                                <label for="args-popsize"  class="col-sm-4">Pop size</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="args-popsize">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="args-pe"  class="col-sm-4">Part of extremist on each dimension</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="args-pe" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="args-eip"  class="col-sm-4">Part of highly self-engaged in dimension 1</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="args-eip" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="args-mu0"  class="col-sm-4">mu dimension 1</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="args-mu0" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="args-mu1"  class="col-sm-4">mu dimension 2</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="args-mu1" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="args-u0"  class="col-sm-4">uncertainty on dimension 1</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="args-u0" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="args-u1"  class="col-sm-4">uncertainty on dimension 2</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="args-u1" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="args-nbSteps" class="col-sm-4">Nb steps to run</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="args-nbSteps">
                                </div>
                            </div>
                            <!--div class="form-group">
                                    <label for="typeRencontre"  class="col-sm-4">Type rencontre</label>
                                    <div class="col-sm-4">
                                        <select class="form-control" id="typeRencontre">
                                            <option value="0">PBC JDM</option>
                                            <option value="1">BC simple</option>
                                            <option value="2">Relative Agreement</option>
                                            <option value="3">MouvARNonHierarchise</option>
                                            <option value="4" selected="selected">MouvARHierarchise</option>
                                        </select>
                                    </div>
                                </div-->
                        </form>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="plots">
                        <div class="col-lg-6" id="plot-opinions"></div>
                        <div class="col-lg-6" id="plot-indicators"></div>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            var simulationRun = true;
            var stopIteration = 0;
            var paused = false;
            var iteration = 0;
            var pop;
            var opinionsTs = []; // opinions time series
            var timeserieStep = 1;
            var extremistId = []; // extremist IDs
            var indicatorsRange = [];
            var indicatorsTs = {nbClusters: [], nbIsolatedInd: [], opAvg0: [], opAvg1: []};
            var stepsDuration = 0;
            var plotDuration = -1;
            var nextPlotsTimestep = -1;
            var plotsToRefresh = -1;
            function loadURLArguments() {
                // load default parameters
                resetParameters();
                // load URL arguments
                var params = (window.location.hash.substr(1)).split("&");
                for (i = 0; i < params.length; i++) {
                    var a = params[i].split("=");
                    $('#args-' + a[0]).val(a[1]);
                }
                updatePermalink();
            }
            function updatePermalink() {
                var urlHash = "";
                $('#config input').each(function (input) {
                    var name = $(this).attr('id').replace('args-', '');
                    urlHash += name + "=" + $(this).val() + "&";
                });
                $('#permalink').attr('href', "#" + urlHash.slice(0, -1));
            }
            /**
             * Resets to default parameters
             */
            function resetParameters() {
                $('#args-popsize').val(5000);
                $('#args-pe').val(0);
                $('#args-eip').val(0);
                $('#args-mu0').val(0.5);
                $('#args-mu1').val(0.5);
                $('#args-u0').val(0.3);
                $('#args-u1').val(0.1);
                $('#args-nbSteps').val(3000);
                // force slider update
                $('#args-nbSteps').trigger("input");
            }
            function initSimulation() {
                $('#plot-opinions').empty();
                $('#plot-indicators').empty();
                opinionsTs = [];
                timeserieStep = 1;
                extremistId = [];
                indicatorsRange = [];
                simulationRun = false;
                iteration = 0;
                stepsDuration = 0;
                plotDuration = -1;
                nextPlotsTimestep = -1;
                plotsToRefresh = -1;
                stopIteration = iteration + parseInt($('#args-nbSteps').val(), 10);
                itSlider.val(0);
                itSliderVal.text('0');
                itSlider.attr('max', stopIteration);
                itSliderMax.text(stopIteration);
                updatePermalink();
            }
            function simulation() {
                if (simulationRun) {
                    if (opinionsTs.length === 0) {
                        // initialization step
                        pop = new Population(
                                parseInt($('#args-popsize').val(), 10),
                                parseFloat($('#args-pe').val(), 10),
                                parseFloat($('#args-eip').val(), 10),
                                [parseFloat($('#args-mu0').val(), 10), parseFloat($('#args-mu1').val(), 10)],
                                [parseFloat($('#args-u0').val(), 10), parseFloat($('#args-u1').val(), 10)]
                                //parseInt($('#typeRencontre').val(), 10)
                                );
                        var x = new Array(pop.parameters.taille);
                        var y = new Array(pop.parameters.taille);
                        var ids = [];
                        for (var i = 0; i < pop.parameters.taille; i++) {
                            x[i] = pop.population[i].sBavg[0][0];
                            y[i] = pop.population[i].sBavg[0][1];
                            if (pop.population[i].isExtremist()) {
                                ids.push(i);
                            }
                        }
                        opinionsTs.push([x, y]);
                        extremistId.push(ids);
                        initPlotIndicators(indicatorsTs);
                        var start = new Date().getTime();
                        updatePlotIndicators(iteration);
                        plotDuration = new Date().getTime() - start;
                    }
                    // regular step
                    iteration = iteration + 1;
                    var start = new Date().getTime();
                    pop.iter(iteration);
                    stepsDuration = stepsDuration + new Date().getTime() - start;
                    var x = new Array();
                    var y = new Array();
                    var xHighlyEngaged = new Array();
                    var yHighlyEngaged = new Array();
                    for (var i = 0; i < pop.parameters.taille; i++) {
                        if (pop.population[i].isHighlyEngaged()) {
                            xHighlyEngaged.push(pop.population[i].sBavg[0][0]);
                            yHighlyEngaged.push(pop.population[i].sBavg[0][1]);
                        } else {
                            x.push(pop.population[i].sBavg[0][0]);
                            y.push(pop.population[i].sBavg[0][1]);
                        }
                    }
                    // overriding last data in timeserie until we reach the next timeserieStep
                    opinionsTs[Math.ceil(iteration / timeserieStep)] = [x, y, xHighlyEngaged, yHighlyEngaged];
                    var frequency = $('#plots-frequency input:checked').attr('value');
                    if (frequency !== "off") {
                        if (nextPlotsTimestep === -1) {
                            computeNextPlotsTimestep(frequency);
                        }
                        if (iteration === nextPlotsTimestep) {
                            updatePlotIndicators(iteration);
                            computeNextPlotsTimestep(frequency);
                        }
                    }
                    if (iteration === 1000) {
                        // dumping 99% of conserved data
                        timeserieStep = 100;
                        itSlider.attr('step', timeserieStep);
                        opinionsTs = opinionsTs.filter(function (elt, i) {
                            return i % timeserieStep === 0;
                        });
                    }
                    itSlider.val(iteration);
                    itSliderVal.text(iteration);
                    simulationRun = iteration < stopIteration;
                    setTimeout(simulation, 0);
                } else {
                    $('#play-btn span').removeClass('glyphicon-pause');
                    $('#play-btn span').addClass('glyphicon-play');
                }
            }
            var playBtn = $('#play-btn');
            var pauseBtn = $('#pause-btn');
            var stopBtn = $('#stop-btn');
            var itSlider = $("#iterationSlider");
            var itSliderMax = $("#iterationSlider-max");
            var itSliderVal = $("#iterationSlider-val");
            // Controls events
            $('#config input').on('change', function () {
                updatePermalink();
            });
            function pause() {
                $('#play-btn span').removeClass('glyphicon-pause');
                $('#play-btn span').addClass('glyphicon-play');
                simulationRun = false;
                paused = true;
            }
            playBtn.click(function () {
                if (simulationRun) {
                    pause();
                    updatePlotIndicators(iteration);
                } else {
                    $('html, body').animate({scrollTop: $('#simulator').position().top}, 500);
                    $('#play-btn span').removeClass('glyphicon-play');
                    $('#play-btn span').addClass('glyphicon-pause');
                    $('#resetParameters').hide();
                    $('#config input').prop("disabled", true);
                    $('#args-nbSteps').prop("disabled", false);
                    $('#config select').prop("disabled", true);
                    $('#tabs a[href="#plots"]').tab('show');
                    simulationRun = true;
                    if (!paused) {
                        stopIteration = iteration + parseInt($('#args-nbSteps').val(), 10);
                        itSlider.attr('max', stopIteration);
                        itSliderMax.text(stopIteration);
                    } else {
                        paused = false;
                    }
                    setTimeout(simulation, 0);
                    setTimeout(refreshLoop, 200);
                }
            });
            stopBtn.click(pause);
            $('#stop-confirmed').click(function () {
                initSimulation();
                $('#config input').prop("disabled", false);
                $('#config select').prop("disabled", false);
                $('#resetParameters').show();
                $('#tabs a[href="#config"]').tab('show');
                $('#confirm-stop').modal('hide');
            });
            $('#resetParameters').on('click', function () {
                resetParameters();
                window.location.hash = "";
                updatePermalink();
            });
            $('#args-nbSteps').on("input", function () {
                var step = iteration + parseInt(this.value, 10);
                itSlider.attr('max', step);
                itSliderMax.text(step);
                stopIteration = step;
            });
            itSlider.on("change", function () {
                console.log(this.value);
                if (this.value <= iteration) {
                    updatePlotIndicators(parseInt(this.value, 10));
                    refresh(parseInt(this.value, 10));
                }
            });
            itSlider.on("input", function () {
                if (this.value > iteration) {
                    itSlider.val(iteration);
                } else {
                    itSliderVal.text(this.value);
                }
            });
            $('#plots-frequency input').on('change', function () {
                computeNextPlotsTimestep($(this).attr('value'));
            });
            // Ok, we're ready
            initSimulation();
            loadURLArguments();
            // <!-- Piwik -->
            var _paq = _paq || [];
            _paq.push(["setDomains", ["*.motive.cemagref.fr"]]);
            _paq.push(['trackPageView']);
            _paq.push(['enableLinkTracking']);
            (function () {
                var u = "//motive.cemagref.fr/piwik/";
                _paq.push(['setTrackerUrl', u + 'piwik.php']);
                _paq.push(['setSiteId', 2]);
                var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
                g.type = 'text/javascript';
                g.async = true;
                g.defer = true;
                g.src = u + 'piwik.js';
                s.parentNode.insertBefore(g, s);
            }
            )();
            //<!-- End Piwik Code -->
        </script>
    </body>
</html>
