 
<html>
    <head>
        <title>Various Bounded Confidence</title>
        <link href="css/bootstrap-3.3.6.min.css" rel="stylesheet">
        <script type="text/javascript"  src="js/plotly-latest.min.js"></script>
        <script type="text/javascript" src="js/population.js"></script>
        <script type="text/javascript" src="js/plots.js"></script>
        <script type="text/javascript" src="js/jquery-2.2.0.min.js"></script>
        <script type="text/javascript" src="js/bootstrap-3.3.6.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="jumbotron">
                <h1>Various Bounded Confidence</h1>
                <p class="lead">Discover the dynamics of bounded confidence models<!-- described in
                    <a href="http://jasss.soc.surrey.ac.uk/19/1/6.html" title="Mathias, Jean-Denis, Huet, Sylvie and Deffuant, Guillaume (2016) 'Bounded Confidence Model with Fixed Uncertainties and Extremists: The Opinions Can Keep Fluctuating Indefinitely' Journal of Artificial Societies and Social Simulation 19 (1) 6">(Deffuant et al., 2016)</a-->
                </p>
            </div>
            <!--div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Help</h3>
                </div>
                <div class="panel-body">
                    
                </div>
            </div-->
            <div id="simulator">
                <div class="input-group col-sm-12">
                    <label id="play-btn" class="btn btn-default input-group-addon"><span class="glyphicon glyphicon-play"></span></label>
                    <span class="input-group-addon" id="iterationSlider-val">0</span>
                    <input id="iterationSlider" class="form-control" type="range" min="0" value="0"/>
                    <span class="input-group-addon" id="iterationSlider-max"></span>
                </div>
                <form  id="plots-frequency">
                    <div class="input-group col-sm-6">
                        <span class="input-group-addon" title="Sets the frequency of the computing and redrawing process for the plots.">
                            Plots frequency
                        </span>
                        <div class="btn-group" data-toggle="buttons">
                            <label class="btn btn-default active" title="Computes a frequency giving low-priority for plots">
                                <input type="radio" name="options" value="auto" autocomplete="off" checked>Auto
                            </label>
                            <label class="btn btn-default" title="Every timestep">
                                <input type="radio" name="options" value="1" autocomplete="off">1
                            </label>
                            <label class="btn btn-default" title="Every 10 timesteps">
                                <input type="radio" name="options" value="10" autocomplete="off">10
                            </label>
                            <label class="btn btn-default" title="Every 100 timesteps">
                                <input type="radio" name="options" value="100" autocomplete="off">100
                            </label>
                            <label class="btn btn-default" title="Disable the plots updating process">
                                <input type="radio" name="options" value="off" autocomplete="off">Off
                            </label>
                        </div>
                    </div>
                </form>
                <!-- Nav tabs -->
                <ul id="tabs" class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#config" aria-controls="config" role="tab" data-toggle="tab">Config</a></li>
                    <li role="presentation"><a href="#plots" aria-controls="plots" role="tab" data-toggle="tab">Plots</a></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="config">
                        <form class="form-horizontal" role="form">
                            <div class="form-group">
                                <label for="popSizeInput"  class="col-sm-4">Pop size</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="popSizeInput" value="5000">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="pe"  class="col-sm-4">Part of extremist on each dimension</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="pe" value="0.0" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="egoInvolvedPart"  class="col-sm-4">Part of highly self-engaged in dimension 1</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="egoInvolvedPart" value="0.0" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mu0"  class="col-sm-4">mu dimension 1</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="mu0" value="0.5" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mu1"  class="col-sm-4">mu dimension 2</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="mu1" value="0.5" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="valBaseIncert0"  class="col-sm-4">uncertainty on dimension 1</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="valBaseIncert0" value="0.3" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="valBaseIncert1"  class="col-sm-4">uncertainty on dimension 2</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="valBaseIncert1" value="0.1" step="0.1" min="0" max="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="nbSteps" class="col-sm-4">Nb steps to run</label>
                                <div class="col-sm-4">
                                    <input type="number" class="form-control" id="nbSteps" value="3000">
                                </div>
                            </div>
                            <!--div class="form-group">
                                    <label for="typeRencontre"  class="col-sm-4">Type rencontre</label>
                                    <div class="col-sm-4">
                                        <select class="form-control" id="typeRencontre">
                                            <option value="0">PBC JDM</option>
                                            <option value="1">BC simple</option>
                                            <option value="2">Relative Agreement</option>
                                            <option value="3">MouvARNonHierarchise</option>
                                            <option value="4" selected="selected">MouvARHierarchise</option>
                                        </select>
                                    </div>
                                </div-->
                        </form>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="plots">
                        <div class="col-lg-6" id="plot-opinions"></div>
                        <div class="col-lg-6" id="plot-indicators"></div>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            var simulationRun = true;
            var stopIteration = 0;
            var paused = false;
            var iteration = 0;
            var pop;
            var opinionsTs = []; // opinions time series
            var extremistId = []; // extremist IDs
            var indicatorsRange = [];
            var indicatorsTs = {nbClusters: [], nbIsolatedInd: [], opAvg0: [], opAvg1: []};
            var stepsDuration = 0;
            var plotDuration = -1;
            var nextPlotsTimestep = -1;
            var plotsToRefresh = -1;
            function initSimulation() {
                $('#plot-opinions').empty();
                $('#plot-indicators').empty();
                opinionsTs = [];
                extremistId = [];
                indicatorsRange = [];
                simulationRun = false;
                iteration = 0;
                stepsDuration = 0;
                plotDuration = -1;
                nextPlotsTimestep = -1;
                plotsToRefresh = -1;
                stopIteration = iteration + parseInt($('#nbSteps').val(), 10);
                itSlider.val(0);
                itSliderVal.text('0');
                itSlider.attr('max', stopIteration);
                itSliderMax.text(stopIteration);
            }
            function simulation() {
                if (simulationRun) {
                    if (opinionsTs.length === 0) {
                        pop = new Population(
                                parseInt($('#popSizeInput').val(), 10),
                                parseFloat($('#pe').val(), 10),
                                parseFloat($('#egoInvolvedPart').val(), 10),
                                [parseFloat($('#mu0').val(), 10), parseFloat($('#mu1').val(), 10)],
                                [parseFloat($('#valBaseIncert0').val(), 10), parseFloat($('#valBaseIncert1').val(), 10)]
                                //parseInt($('#typeRencontre').val(), 10)
                                );
                        var x = new Array(pop.parameters.taille);
                        var y = new Array(pop.parameters.taille);
                        var ids = [];
                        for (var i = 0; i < pop.parameters.taille; i++) {
                            x[i] = pop.population[i].sBavg[0][0];
                            y[i] = pop.population[i].sBavg[0][1];
                            if (pop.population[i].isExtremist()) {
                                ids.push(i);
                            }
                        }
                        opinionsTs.push([x, y]);
                        extremistId.push(ids);
                        initPlotIndicators(indicatorsTs);
                        var start = new Date().getTime();
                        updatePlotIndicators(iteration);
                        plotDuration = new Date().getTime() - start;
                    }
                    iteration = iteration + 1;
                    var start = new Date().getTime();
                    pop.iter(iteration);
                    stepsDuration = stepsDuration + new Date().getTime() - start;
                    var x = new Array(pop.parameters.taille);
                    var y = new Array(pop.parameters.taille);
                    for (var i = 0; i < pop.parameters.taille; i++) {
                        x[i] = pop.population[i].sBavg[0][0];
                        y[i] = pop.population[i].sBavg[0][1];
                    }
                    opinionsTs.push([x, y]);
                    var frequency = $('#plots-frequency input:checked').attr('value');
                    if (frequency !== "off") {
                        if (nextPlotsTimestep === -1) {
                            computeNextPlotsTimestep(frequency);
                        }
                        if (iteration === nextPlotsTimestep) {
                            updatePlotIndicators(iteration);
                            computeNextPlotsTimestep(frequency);
                        }
                    }
                    itSlider.val(iteration);
                    itSliderVal.text(iteration);
                    simulationRun = iteration < stopIteration;
                    setTimeout(simulation, 0);
                } else {
                    $('#play-btn span').removeClass('glyphicon-pause');
                    $('#play-btn span').addClass('glyphicon-play');
                }
            }
            var playBtn = $('#play-btn');
            var pauseBtn = $('#pause-btn');
            var stopBtn = $('#stop-btn');
            var itSlider = $("#iterationSlider");
            var itSliderMax = $("#iterationSlider-max");
            var itSliderVal = $("#iterationSlider-val");
            // Controls events
            playBtn.click(function () {
                if (simulationRun) {
                    $('#play-btn span').removeClass('glyphicon-pause');
                    $('#play-btn span').addClass('glyphicon-play');
                    simulationRun = false;
                    paused = true;
                    updatePlotIndicators(iteration);
                } else {
                    $('html, body').animate({scrollTop: $('#simulator').position().top}, 500);
                    $('#play-btn span').removeClass('glyphicon-play');
                    $('#play-btn span').addClass('glyphicon-pause');
                    $('#config input').prop("disabled", true);
                    $('#nbSteps').prop("disabled", false);
                    $('#config select').prop("disabled", true);
                    $('#tabs a[href="#plots"]').tab('show');
                    simulationRun = true;
                    if (!paused) {
                        stopIteration = iteration + parseInt($('#nbSteps').val(), 10);
                        itSlider.attr('max', stopIteration);
                        itSliderMax.text(stopIteration);
                    } else {
                        paused = false;
                    }
                    setTimeout(simulation, 0);
                    setTimeout(refreshLoop, 200);
                }
            });
            $('#nbSteps').on("input", function () {
                var step = iteration + parseInt(this.value, 10);
                itSlider.attr('max', step);
                itSliderMax.text(step);
                stopIteration = step;
            });
            itSlider.on("change", function () {
                if (this.value <= iteration) {
                    updatePlotIndicators(parseInt(this.value, 10));
                    refresh(this.value);
                }
            });
            itSlider.on("input", function () {
                if (this.value > iteration) {
                    itSlider.val(iteration);
                } else {
                    itSliderVal.text(this.value);
                }
            });
            $('#plots-frequency input').on('change', function () {
                computeNextPlotsTimestep($(this).attr('value'));
            });
            // Ok, we're ready
            initSimulation();
            // <!-- Piwik -->
            var _paq = _paq || [];
            _paq.push(["setDomains", ["*.motive.cemagref.fr"]]);
            _paq.push(['trackPageView']);
            _paq.push(['enableLinkTracking']);
            (function () {
                var u = "//motive.cemagref.fr/piwik/";
                _paq.push(['setTrackerUrl', u + 'piwik.php']);
                _paq.push(['setSiteId', 2]);
                var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
                g.type = 'text/javascript';
                g.async = true;
                g.defer = true;
                g.src = u + 'piwik.js';
                s.parentNode.insertBefore(g, s);
            })();
            //<!-- End Piwik Code -->
        </script>
    </body>
</html>
