 
<html>
    <head>
        <title>Various Bounded Confidence</title>
        <link href="css/bootstrap-3.3.6.min.css" rel="stylesheet">
        <script type="text/javascript"  src="js/plotly-latest.min.js"></script>
        <script type="text/javascript" src="js/population.js"></script>
        <script type="text/javascript" src="js/jquery-2.2.0.min.js"></script>
        <script type="text/javascript" src="js/bootstrap-3.3.6.min.js"></script>
    </head>
    <body>
        <div class="modal fade" id="confirm-stop" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog"><div class="modal-content">
                    <div class="modal-header"><h4 class="modal-title" id="myModalLabel">Confirmation</h4></div>
                    <div class="modal-body">Are you sure to stop this simulation and to reset all the results?</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button id="stop-confirmed" type="button" class="btn btn-danger danger">Stop</button>
                    </div>
                </div>
            </div>
        </div>                
        <div class="container">
            <div class="jumbotron">
                <h1>Various Bounded Confidence</h1>
                <p class="lead">Discover the dynamics of bounded confidence models<!-- described in
                    <a href="http://jasss.soc.surrey.ac.uk/19/1/6.html" title="Mathias, Jean-Denis, Huet, Sylvie and Deffuant, Guillaume (2016) 'Bounded Confidence Model with Fixed Uncertainties and Extremists: The Opinions Can Keep Fluctuating Indefinitely' Journal of Artificial Societies and Social Simulation 19 (1) 6">(Deffuant et al., 2016)</a-->
                </p>
            </div>
            <!--div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Help</h3>
                </div>
                <div class="panel-body">
                    
                </div>
            </div-->
            <div>
                <form class="form-inline">
                    <div class="input-group col-sm-4">
                        <span class="input-group-addon">Nb steps to run</span>
                        <input type="number" class="form-control" id="nbSteps" value="1000">
                    </div>
                    <div class="btn-group col-sm-4">
                        <button type="button" id="play-btn" class="btn btn-default"><span class="glyphicon glyphicon-play"> Play</span></button>
                        <button type="button" id="pause-btn" class="btn btn-default" disabled="disabled"><span class="glyphicon glyphicon-pause"> Pause</span></button>
                        <button type="button" id="stop-btn" class="btn btn-default" disabled="disabled" data-toggle="modal" data-target="#confirm-stop"><span class="glyphicon glyphicon-stop"> Stop</span></button>
                    </div>
                </form>
            </div>
            <div class="input-group col-sm-12">
                <span class="input-group-addon">Iteration</span>
                <span class="input-group-addon" id="iterationSlider-val">0</span>
                <input id="iterationSlider" class="form-control" type="range" min="0" max="100" value="0"/>
                <span class="input-group-addon" id="iterationSlider-max">500</span>
            </div>
            <form  id="plots-frequency">
                <div class="input-group col-sm-6">
                    <span class="input-group-addon" title="Sets the frequency of the computing and redrawing process for the plots.">
                        Plots frequency
                    </span>
                    <div class="btn-group" data-toggle="buttons">
                        <label class="btn btn-default active" title="Computes a frequency giving low-priority for plots">
                            <input type="radio" name="options" value="auto" autocomplete="off" checked>Auto
                        </label>
                        <label class="btn btn-default" title="Every timestep">
                            <input type="radio" name="options" value="1" autocomplete="off">1
                        </label>
                        <label class="btn btn-default" title="Every 10 timesteps">
                            <input type="radio" name="options" value="10" autocomplete="off">10
                        </label>
                        <label class="btn btn-default" title="Every 100 timesteps">
                            <input type="radio" name="options" value="100" autocomplete="off">100
                        </label>
                        <label class="btn btn-default" title="Disable the plots updating process">
                            <input type="radio" name="options" value="off" autocomplete="off">Off
                        </label>
                    </div>
                </div>
            </form>
            <!-- Nav tabs -->
            <ul id="tabs" class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#config" aria-controls="config" role="tab" data-toggle="tab">Config</a></li>
                <li role="presentation"><a href="#plots" aria-controls="plots" role="tab" data-toggle="tab">Plots</a></li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="config">
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <label for="popSizeInput"  class="col-sm-4">Pop size</label>
                            <div class="col-sm-4">
                                <input type="number" class="form-control" id="popSizeInput" value="5000">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pe"  class="col-sm-4">Part of extremist on each dimension</label>
                            <div class="col-sm-4">
                                <input type="number" class="form-control" id="pe" value="0.0" step="0.1" min="0" max="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="egoInvolvedPart"  class="col-sm-4">Part of highly self-engaged in dimension 1</label>
                            <div class="col-sm-4">
                                <input type="number" class="form-control" id="pe" value="0.0" step="0.1" min="0" max="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mu0"  class="col-sm-4">mu dimension 1</label>
                            <div class="col-sm-4">
                                <input type="number" class="form-control" id="mu0" value="0.5" step="0.1" min="0" max="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mu1"  class="col-sm-4">mu dimension 2</label>
                            <div class="col-sm-4">
                                <input type="number" class="form-control" id="mu1" value="0.5" step="0.1" min="0" max="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="valBaseIncert0"  class="col-sm-4">uncertainty on dimension 1</label>
                            <div class="col-sm-4">
                                <input type="number" class="form-control" id="valBaseIncert0" value="0.3" step="0.1" min="0" max="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="valBaseIncert1"  class="col-sm-4">uncertainty on dimension 2</label>
                            <div class="col-sm-4">
                                <input type="number" class="form-control" id="valBaseIncert1" value="0.1" step="0.1" min="0" max="1">
                            </div>
                        </div>
                        <!--div class="form-group">
                            <label for="typeRencontre"  class="col-sm-4">Type rencontre</label>
                            <div class="col-sm-4">
                                <select class="form-control" id="typeRencontre">
                                    <option value="0">PBC JDM</option>
                                    <option value="1">BC simple</option>
                                    <option value="2">Relative Agreement</option>
                                    <option value="3">MouvARNonHierarchise</option>
                                    <option value="4" selected="selected">MouvARHierarchise</option>
                                </select>
                            </div>
                        </div-->
                    </form>
                </div>
                <div role="tabpanel" class="tab-pane" id="plots">
                    <div class="col-lg-6" id="plot-opinions"></div>
                    <div class="col-lg-6" id="plot-indicators"></div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            function plotOpinions(x, y, step) {
                var data = [{
                        x: x,
                        y: y,
                        mode: 'markers',
                        name: 'points',
                        marker: {
                            color: 'rgb(102,0,0)',
                            size: 2,
                            opacity: 0.4
                        },
                        type: 'scatter'
                    }, {
                        x: x,
                        y: y,
                        name: 'density',
                        ncontours: 20,
                        colorscale: 'Hot',
                        reversescale: true,
                        showscale: true,
                        type: 'histogram2dcontour'
                    }, {
                        x: x,
                        name: 'opinion 1 density',
                        marker: {color: 'rgb(102,0,0)'},
                        yaxis: 'y2',
                        type: 'histogram'
                    }, {
                        y: y,
                        name: 'opinion 2 density',
                        marker: {color: 'rgb(102,0,0)'},
                        xaxis: 'x2',
                        type: 'histogram'
                    }];
                var opinionAxis = {
                    range: [-1, 1],
                    autorange: false,
                    domain: [0, 0.8],
                    showgrid: false,
                    zeroline: false
                };
                var densitiAxis = {
                    domain: [0.85, 1],
                    showgrid: false,
                    zeroline: false
                };
                var layout = {
                    title: 'Opinions densities at step ' + step,
                    showlegend: false,
                    autosize: false,
                    width: 600,
                    height: 550,
                    margin: {t: 50},
                    hovermode: 'closest',
                    bargap: 0,
                    xaxis: $.extend({title: 'opinion 1'}, opinionAxis),
                    yaxis: $.extend({title: 'opinion 2'}, opinionAxis),
                    xaxis2: densitiAxis,
                    yaxis2: densitiAxis
                };
                p = Plotly.newPlot('plot-opinions', data, layout);
                return [p, x, y];
            }
            // TODO échelle de couleurs commence à 0,200 (cf. quand on démarre avec des extrémistes)
            function initPlotIndicators(indicatorsTs) {
                var trace1 = {
                    name: 'nb clusters',
                    x: indicatorsRange,
                    y: indicatorsTs.nbClusters,
                    type: 'scatter'
                };
                var trace2 = {
                    name: 'opinion 1',
                    x: indicatorsRange,
                    y: indicatorsTs.opAvg0,
                    yaxis: 'y2',
                    type: 'scatter'
                };
                var trace3 = {
                    name: 'opinion 2',
                    x: indicatorsRange,
                    y: indicatorsTs.opAvg1,
                    yaxis: 'y2',
                    type: 'scatter'
                };
                var data = [trace1, trace2, trace3];
                Plotly.newPlot('plot-indicators', data, {width: 600, height: 550, yaxis: {title: 'nb clusters', range: [0, 5000]},
                    yaxis2: {
                        title: 'opinions mean (absolute values)',
                        range: [0, 1],
                        overlaying: 'y',
                        side: 'right'
                    }});
            }
            function updatePlotIndicators(timestep) {
                // find where the data should be inserted in the timeseries
                var insertionIndex = indicatorsRange.findIndex(function (x) {
                    return x > timestep;
                });
                if (insertionIndex < 0) {
                    // no index greater, so we should append to the end
                    insertionIndex = indicatorsRange.length;
                } else if (indicatorsRange[insertionIndex] === timestep) {
                    // indicators for this timestep have been already computed, so passing
                    return;
                }
                indicatorsTs.nbClusters.splice(insertionIndex, 0, getClusters(timestep, 0.01).length);
                indicatorsTs.opAvg0.splice(insertionIndex, 0, getOpAvg(timestep, 0));
                indicatorsTs.opAvg1.splice(insertionIndex, 0, getOpAvg(timestep, 1));
                indicatorsRange.splice(insertionIndex, 0, timestep);
                plotsToRefresh = true;
            }
            function getOpAvg(timestep, subj) {
                return opinionsTs[timestep][subj].reduce(function (prev, cur) {
                    return prev + Math.abs(cur);
                }, 0) / opinionsTs[timestep][subj].length;
            }
            function getClusters(timestep, epsilon) {
                // gathering index of moderate individuals
                var todo = range(opinionsTs[timestep][0].length).filter(function (indIndex) {
                    return extremistId.indexOf(indIndex) < 0;
                });
                var opinions = opinionsTs[timestep];
                var clusters = [];
                while (todo.length > 0) {
                    var currentIndex = todo.pop();
                    var currentIndiv = [opinions[0][currentIndex], opinions[1][currentIndex]];
                    var currentCluster = [currentIndiv];
                    range(todo.length).filter(function (todoIndex) {
                        return Individual.distance(currentIndiv[0], currentIndiv[1], opinions[0][todo[todoIndex]], opinions[1][todo[todoIndex]]) < epsilon;
                    }).forEach(function (todoIndex) {
                        var index = todo.splice(todoIndex, 1)[0];
                        currentCluster.push([opinions[0][index], opinions[1][index]]);
                    });
                    clusters.push(currentCluster);
                }
                return clusters;
            }
            var simulationRun = true;
            var stopIteration = 0;
            var paused = false;
            var iteration = 0;
            var pop;
            var opinionsTs = []; // opinions time series
            var extremistId = []; // extremist IDs
            var indicatorsRange = [];
            var indicatorsTs = {nbClusters: [], opAvg0: [], opAvg1: []};
            function initSimulation() {
                $('#plot-opinions').empty();
                $('#plot-indicators').empty();
                opinionsTs = [];
                extremistId = [];
                indicatorsRange = [];
                simulationRun = false;
                iteration = 0;
                stepsDuration = 0;
                plotDuration = -1;
                nextPlotsTimestep = -1;
                plotsToRefresh = false;
                stopIteration = iteration + parseInt($('#nbSteps').val(), 10);
                itSlider.val(0);
                itSliderVal.text('0');
                itSlider.attr('max', stopIteration);
                itSliderMax.text(stopIteration);
                setButtonsStates(true, false, true);
            }
            function refresh(timestep) {
                Plotly.redraw(document.getElementById('plot-indicators'));
                plotOpinions(opinionsTs[timestep][0], opinionsTs[timestep][1], timestep);
            }
            var stepsDuration = 0;
            var plotDuration = -1;
            var nextPlotsTimestep = -1;
            var plotsToRefresh = false;
            function refreshLoop() {
                if (simulationRun) {
                    if (plotsToRefresh) {
                        plotsToRefresh = false;
                        refresh(iteration);
                    }
                    setTimeout(refreshLoop, 200);
                }
            }
            function simulation() {
                if (simulationRun) {
                    if (opinionsTs.length === 0) {
                        pop = new Population(
                                parseInt($('#popSizeInput').val(), 10),
                                parseFloat($('#pe').val(), 10),
                                parseFloat($('#egoInvolvedPart').val(), 10),
                                [parseFloat($('#mu0').val(), 10), parseFloat($('#mu1').val(), 10)],
                                [parseFloat($('#valBaseIncert0').val(), 10), parseFloat($('#valBaseIncert1').val(), 10)]
                                //parseInt($('#typeRencontre').val(), 10)
                                );
                        var x = new Array(pop.parameters.taille);
                        var y = new Array(pop.parameters.taille);
                        var ids = [];
                        for (var i = 0; i < pop.parameters.taille; i++) {
                            x[i] = pop.population[i].sBavg[0][0];
                            y[i] = pop.population[i].sBavg[0][1];
                            if (pop.population[i].isExtremist()) {
                                ids.push(i);
                            }
                        }
                        opinionsTs.push([x, y]);
                        extremistId.push(ids);
                        initPlotIndicators(indicatorsTs);
                        var start = new Date().getTime();
                        updatePlotIndicators(iteration);
                        plotDuration = new Date().getTime() - start;
                    }
                    iteration = iteration + 1;
                    var start = new Date().getTime();
                    pop.iter(iteration);
                    stepsDuration = stepsDuration + new Date().getTime() - start;
                    var x = new Array(pop.parameters.taille);
                    var y = new Array(pop.parameters.taille);
                    for (var i = 0; i < pop.parameters.taille; i++) {
                        x[i] = pop.population[i].sBavg[0][0];
                        y[i] = pop.population[i].sBavg[0][1];
                    }
                    opinionsTs.push([x, y]);
                    var frequency = $('#plots-frequency input:checked').attr('value');
                    if (frequency !== "off") {
                        if (nextPlotsTimestep === -1) {
                            computeNextPlotsTimestep(frequency);
                        }
                        if (iteration === nextPlotsTimestep) {
                            updatePlotIndicators(iteration);
                            plotsToRefresh = true;
                            computeNextPlotsTimestep(frequency);
                        }
                    }
                    itSlider.val(iteration);
                    itSliderVal.text(iteration);
                    simulationRun = iteration < stopIteration;
                    setTimeout(simulation, 0);
                } else {
                    setButtonsStates(true, false, true);
                }
            }
            function computeNextPlotsTimestep(frequency) {
                if (frequency === 'auto') {
                    nextPlotsTimestep = iteration + Math.round(plotDuration / (stepsDuration / iteration) * 4);
                } else {
                    nextPlotsTimestep = iteration + parseInt(frequency, 0);
                    if (iteration === 1) { // fix for first iteration, for avoiding disgracious shift
                        nextPlotsTimestep -= 1;
                    }
                }
            }
            var playBtn = $('#play-btn');
            var pauseBtn = $('#pause-btn');
            var stopBtn = $('#stop-btn');
            var itSlider = $("#iterationSlider");
            var itSliderMax = $("#iterationSlider-max");
            var itSliderVal = $("#iterationSlider-val");
            function setButtonsStates(play, pause, stop) {
                playBtn.prop('disabled', !play);
                pauseBtn.prop('disabled', !pause);
                stopBtn.prop('disabled', !stop);
            }
            // Controls events
            function play() {
                $('#config input').prop("disabled", true);
                $('#config select').prop("disabled", true);
                $('#tabs a[href="#plots"]').tab('show');
                simulationRun = true;
                setButtonsStates(false, true, true);
                if (!paused) {
                    stopIteration = iteration + parseInt($('#nbSteps').val(), 10);
                    itSlider.attr('max', stopIteration);
                    itSliderMax.text(stopIteration);
                } else {
                    paused = false;
                }
                setTimeout(simulation, 0);
                setTimeout(refreshLoop, 200);
            }
            function pause() {
                simulationRun = false;
                paused = true;
                setButtonsStates(true, false, true);
            }
            // TODO scroll down with buttons on top on play
            playBtn.click(play);
            pauseBtn.click(pause);
            stopBtn.click(pause);
            $('#stop-confirmed').click(function () {
                initSimulation();
                $('#config input').prop("disabled", false);
                $('#config select').prop("disabled", false);
                $('#tabs a[href="#config"]').tab('show');
                $('#confirm-stop').modal('hide');
            });
            $('#nbSteps').on("input", function () {
                var step = iteration + parseInt(this.value, 10);
                if (iteration === 0) {
                    itSlider.attr('max', step);
                    itSliderMax.text(step);
                }
                stopIteration = step;
            });
            itSlider.on("change", function () {
                if (this.value <= iteration) {
                    updatePlotIndicators(parseInt(this.value, 10));
                    refresh(this.value);
                }
            });
            itSlider.on("input", function () {
                if (this.value > iteration) {
                    itSlider.val(iteration);
                } else {
                    itSliderVal.text(this.value);
                }
            });
            // TODO computeNextPlotsTimestep() when frequency button changed
            // Ok, we're ready
            initSimulation();
        </script>
    </body>
</html>
